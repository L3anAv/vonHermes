---
import Galeria from '../components/Galeria.astro';
import Inicio from '../components/inicio.astro';
import Layout from '../layouts/Layout.astro';
---

<Layout>
    <main class="scroll-container">
        <section id="inicio-section" class="panel">
            <Inicio />
        </section>
        
        <section id="galeria-section" class="panel">
            <Galeria />
        </section>
    </main>
</Layout>

<style is:global>
   /* Estilos base */
    html, body {
        margin: 0;
        padding: 0;
    }

    /* Solo ocultamos la barra y forzamos el alto en pantallas grandes */
    @media (min-width: 1001px) {
        html, body {
            overflow-x: hidden;
            scrollbar-width: none;
        }
        html::-webkit-scrollbar {
            display: none;
        }
        .panel {
            height: 100vh;
            overflow: hidden;
        }
    }

    /* En móviles (<=1000px), el scroll es normal y las secciones fluyen */
    @media (max-width: 1000px) {
        .panel {
            height: auto;
            min-height: 100vh;
        }
    }
</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollToPlugin.min.js"></script>

<script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollToPlugin.min.js"></script>

<script is:inline>
    gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

    let isAnimating = false;

    function initScrollSnap() {
        if (window.innerWidth <= 1000) return;

        // Buscamos el wrapper de la galería que está DENTRO del componente Galeria
        const galleryWrapper = document.getElementById('gallery-wrapper');

        const handleWheel = (e) => {
            if (isAnimating) return;

            const isAtTop = window.scrollY < window.innerHeight / 2;
            
            // 1. Prioridad al scroll horizontal de las fotos
            // Si el movimiento es más lateral que vertical, no hacemos nada y dejamos que Galeria.astro haga lo suyo
            if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                return; 
            }

            // 2. Lógica para bajar (De Inicio a Galería)
            if (e.deltaY > 0 && isAtTop) {
                isAnimating = true;
                gsap.to(window, {
                    scrollTo: window.innerHeight,
                    duration: 0.7,
                    ease: "power2.inOut",
                    onComplete: () => { isAnimating = false; }
                });
            } 
            
            // 3. Lógica para subir (De Galería a Inicio)
            else if (e.deltaY < 0 && !isAtTop) {
                // SOLO saltamos si el carrusel de fotos está al principio (izquierda)
                // Usamos un margen de 10px por si el scroll no es exacto
                const isGalleryAtStart = galleryWrapper ? galleryWrapper.scrollLeft <= 10 : true;

                if (isGalleryAtStart) {
                    isAnimating = true;
                    gsap.to(window, {
                        scrollTo: 0,
                        duration: 0.7,
                        ease: "power2.inOut",
                        onComplete: () => { isAnimating = false; }
                    });
                }
                // Si isGalleryAtStart es falso, no hace nada (permite scrollear fotos hacia la izquierda)
            }
        };

        window.addEventListener("wheel", handleWheel, { passive: false });

        // Efecto Pin para que Inicio no se mueva mientras Galería sube
        ScrollTrigger.create({
            trigger: "#inicio-section",
            start: "top top",
            pin: true,
            pinSpacing: false,
            id: "pin-inicio"
        });
    }

    initScrollSnap();

    window.addEventListener('resize', () => {
        ScrollTrigger.getById("pin-inicio")?.kill();
        initScrollSnap();
    });

    function initMenuNavigation() {
        const btnInstitucional = document.getElementById('btn-institucional');
        const galeriaSection = document.getElementById('galeria-section');

        if (btnInstitucional && galeriaSection) {
            btnInstitucional.addEventListener('click', (e) => {
                // Evitamos el salto brusco nativo del ancla (#)
                e.preventDefault();

                // Si ya hay una animación ocurriendo, no hacemos nada
                if (isAnimating) return;

                isAnimating = true;

                // Animamos el scroll suavemente hasta la sección
                gsap.to(window, {
                    scrollTo: {
                        y: galeriaSection,
                        autoKill: false
                    },
                    duration: 1, // Un poco más lento para que se aprecie el viaje
                    ease: "power2.inOut",
                    onComplete: () => {
                        isAnimating = false;
                        // Actualizamos el hash en la URL sin saltar
                        history.pushState(null, null, '#galeria-section');
                    }
                });
            });
        }
    }

    // Llamamos a la función
    initMenuNavigation();

    function initSmartScroll() {
    // Solo para Desktop
    if (window.innerWidth <= 1000) return;

    gsap.registerPlugin(ScrollToPlugin, ScrollTrigger);

    let isAnimatingPage = false;
    const galleryWrapper = document.getElementById('gallery-wrapper');

    window.addEventListener("wheel", (e) => {
      // Si hay una transición de página en curso, bloqueamos
      if (isAnimatingPage) return;

      // DETECCIÓN CLAVE: ¿Está el mouse sobre el área de fotos?
      const isOverCarousel = e.target.closest('#gallery-wrapper');

      if (isOverCarousel && galleryWrapper) {
        // --- LÓGICA DENTRO DEL CARRUSEL ---
        const isAtStart = galleryWrapper.scrollLeft <= 5;
        const isAtEnd = galleryWrapper.scrollLeft >= (galleryWrapper.scrollWidth - galleryWrapper.clientWidth - 5);
        const scrollingUp = e.deltaY < 0;
        const scrollingDown = e.deltaY > 0;

        // Si el mouse está sobre las fotos pero ya no hay más fotos que scrollear:
        if ((scrollingUp && isAtStart) || (scrollingDown && isAtEnd)) {
          return; // El evento "atraviesa" y va a la lógica de página
        }

        // Si hay fotos por recorrer, movemos el carrusel y bloqueamos el scroll vertical
        if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
          e.preventDefault();
          gsap.to(galleryWrapper, {
            scrollLeft: galleryWrapper.scrollLeft + (e.deltaY * 2),
            duration: 0.6,
            ease: "power2.out",
            overwrite: 'auto'
          });
        }
      } else {
        // --- LÓGICA FUERA DEL CARRUSEL (PÁGINA GENERAL) ---
        const isAtTop = window.scrollY < window.innerHeight / 2;

        if (isAtTop && e.deltaY > 0) {
          // Bajar a Galería
          isAnimatingPage = true;
          gsap.to(window, {
            scrollTo: window.innerHeight,
            duration: 0.8,
            ease: "power2.inOut",
            onComplete: () => { isAnimatingPage = false; }
          });
        } else if (!isAtTop && e.deltaY < 0) {
          // Subir a Inicio
          isAnimatingPage = true;
          gsap.to(window, {
            scrollTo: 0,
            duration: 0.8,
            ease: "power2.inOut",
            onComplete: () => { isAnimatingPage = false; }
          });
        }
      }
    }, { passive: false });
  }

  // Inicialización
  initSmartScroll();
  document.addEventListener('astro:page-load', initSmartScroll);
</script>

<style is:global>
    @media (min-width: 1001px) {
        html, body {
            overflow: hidden; /* Evita el scroll nativo que compite con GSAP */
            height: 100%;
        }
        .panel {
            height: 100vh;
        }
    }
</style>
