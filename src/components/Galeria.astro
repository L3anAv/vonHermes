---
const images = import.meta.glob<{ default: ImageMetadata }>('../assets/images/*', { eager: true });
const imageList = Object.values(images);
---

<dialog id="image-modal">
    <div class="modal-content">
      <button id="close-modal" aria-label="Cerrar">X</button>
      <img id="modal-img" src="" alt="" />
    </div>
</dialog>

<section class="carrusel" id="galeria-section">
  <div class="scroll-container" id="gallery-wrapper">
    {
      imageList.map((img, index) => (
        <div class="img-card">
          <img 
            src={img.default.src} 
            alt={`Imagen galería ${index + 1}`}
            loading="lazy"
            decoding="async"
          />
        </div>
      ))
    }
  </div>

  <div class="footer-title-container">
    <h2 id="hermes-footer">HERMES</h2>
  </div>
</section>

<style>
    .carrusel {
        position: relative;
        z-index: 20;
        display: flex;
        overflow: hidden;
        min-height: 100vh;
        flex-direction: column;
        background-color: #1E1E1E;
    }

    .footer-title-container {
        position: absolute;
        bottom: 40px;
        right: 5vw;
        z-index: 100;
        pointer-events: none;
    }

    #hermes-footer {
        font-family: 'Akira', sans-serif;
        color: #fff;
        margin: 0;
        font-size: clamp(1.5rem, 4vw, 3rem);
        text-transform: uppercase;
        white-space: nowrap;
        /* Estado inicial para la animación de entrada */
        transform: translateX(150%);
        opacity: 0;
        display: block;
        will-change: transform, opacity;
    }

    .scroll-container {
        width: 100%;
        display: flex;
        overflow-x: auto;
        cursor: ew-resize;
        white-space: nowrap;
        scrollbar-width: none;
        padding: 5vh 0;
        scroll-behavior: auto; /* Importante: GSAP maneja la suavidad */
    }

    .scroll-container::-webkit-scrollbar { display: none; }

    .img-card {
        flex: 0 0 auto;
        width: 25%;
        height: 70vh;
        margin: 0 15px;
        overflow: hidden;
    }

    .img-card img {
        width: 100%;
        height: 100%;
        cursor: pointer;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .img-card:hover img { transform: scale(1.05); }

    /* Modal Styles */
    #image-modal {
        background: rgba(16, 24, 40, 0.95);
        border: none;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        padding: 0;
    }

    .modal-content {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }

    #modal-img { max-width: 90%; max-height: 90%; object-fit: contain; }

    #close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: 2px solid #fff;
        color: #fff;
        padding: 5px 15px;
        cursor: pointer;
    }

    @media screen and (max-width: 1166px) {
        .scroll-container { flex-direction: column; padding: 20px; }
        .img-card { width: 100%; height: 50vh; margin: 0 0 20px 0; }
    }
</style>

<script>
    declare const gsap: any;
    declare const ScrollTrigger: any;

    function initGaleriaVisuals() {
        if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
            setTimeout(initGaleriaVisuals, 100);
            return;
        }

        gsap.registerPlugin(ScrollTrigger);

        const hermes = document.getElementById('hermes-footer');
        const section = document.getElementById('galeria-section');
        const container = document.getElementById('gallery-wrapper');
        const modal = document.getElementById('image-modal') as HTMLDialogElement;
        const modalImg = document.getElementById('modal-img') as HTMLImageElement;
        const closeBtn = document.getElementById('close-modal');

        // 1. Animación de entrada de Hermes (Elegante y lenta)
        if (hermes && section) {
            gsap.to(hermes, {
                x: 0,
                opacity: 1,
                ease: "power2.out",
                scrollTrigger: {
                    trigger: section,
                    start: "top bottom",
                    end: "top -50%",
                    scrub: 2,
                    invalidateOnRefresh: true,
                }
            });
        }

        // 2. Lógica del Modal
        if (container && modal && modalImg) {
            container.addEventListener('click', (e) => {
                if (window.innerWidth <= 1166) return;
                const target = e.target as HTMLElement;
                if (target.tagName === 'IMG') {
                    modalImg.src = (target as HTMLImageElement).src;
                    modal.showModal();
                    document.body.style.overflow = 'hidden';
                }
            });

            closeBtn?.addEventListener('click', () => modal.close());
            modal.addEventListener('close', () => document.body.style.overflow = '');
        }
    }

    initGaleriaVisuals();
    document.addEventListener('astro:page-load', initGaleriaVisuals);
</script>